"use strict";var at=(n,t)=>(t=Symbol[n])?t:Symbol.for("Symbol."+n);var U=(n,t,i)=>{if(!t.has(n))throw TypeError("Cannot "+i)};var e=(n,t,i)=>(U(n,t,"read from private field"),i?i.call(n):t.get(n)),r=(n,t,i)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,i)},c=(n,t,i,a)=>(U(n,t,"write to private field"),a?a.call(n,i):t.set(n,i),i);var d=(n,t,i)=>(U(n,t,"access private method"),i);var T=(n,t,i)=>new Promise((a,s)=>{var u=l=>{try{f(i.next(l))}catch(g){s(g)}},p=l=>{try{f(i.throw(l))}catch(g){s(g)}},f=l=>l.done?a(l.value):Promise.resolve(l.value).then(u,p);f((i=i.apply(n,t)).next())});var ot=(n,t,i)=>(t=n[at("asyncIterator")])?t.call(n):(n=n[at("iterator")](),t={},i=(a,s)=>(s=n[a])&&(t[a]=u=>new Promise((p,f,l)=>(u=s.call(n,u),l=u.done,Promise.resolve(u.value).then(g=>p({value:g,done:l}),f)))),i("next"),i("return"),t);Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const ht=require("../notifier/index.cjs"),mt=require("../browser-CpzFX2xg.cjs"),V=require("../url-C3dWnJQg.cjs");var w,h,m,k,P,C,A;class ft{constructor(t,i){r(this,w,void 0);r(this,h,void 0);r(this,m,void 0);r(this,k,void 0);r(this,P,void 0);r(this,C,t=>{t.preventDefault(),e(this,w).links.forEach(i=>{var a;e(this,m)===e(i,m)||(a=e(i,P))!=null&&a.includes(e(this,m))?e(i,h).classList.add("clicked"):e(i,h).classList.remove("clicked")}),e(this,w).navigate(e(this,m),e(this,k))});r(this,A,()=>{e(this,w).prefetch(e(this,m)),e(this,h).removeEventListener("pointerenter",e(this,A))});var u,p;c(this,w,i),c(this,h,t),c(this,m,e(this,h).getAttribute("href")||"/"),c(this,k,e(this,h).getAttribute("data-history-action")||"push"),e(this,h).addEventListener("click",e(this,C));const a=i.normalizePath(e(this,m)),s=i.normalizePath(location.pathname);c(this,P,(u=e(this,h).getAttribute("data-match-paths"))==null?void 0:u.split(",").map(f=>i.normalizePath(f.trim()).pathname)),e(this,h).hasAttribute("data-include")?s.pathname.includes(a.pathname)&&e(this,h).classList.add("current"):a.pathname===s.pathname||(p=e(this,P))!=null&&p.includes(s.pathname)?(e(this,h).classList.add("current"),e(this,h).classList.add("clicked")):e(this,h).classList.remove("clicked"),e(this,h).hasAttribute("data-prefetch")&&e(this,h).addEventListener("pointerenter",e(this,A))}destroy(){e(this,h).removeEventListener("click",e(this,C)),e(this,h).removeEventListener("pointerenter",e(this,A)),e(this,h).classList.remove("current")}}w=new WeakMap,h=new WeakMap,m=new WeakMap,k=new WeakMap,P=new WeakMap,C=new WeakMap,A=new WeakMap;var M,S,z,q,H,K,y,v,L,x,D,R,X,F,Z,I,$,Y,ct,O,tt,_;class pt{constructor(t){r(this,R);r(this,F);r(this,I);r(this,Y);r(this,O);r(this,M,null);r(this,S,null);r(this,z,null);r(this,q,null);r(this,H,[]);r(this,K,new DOMParser);r(this,y,new Map);r(this,v,void 0);r(this,L,null);r(this,x,new ht.Notifier);r(this,D,new ht.Notifier);r(this,_,t=>{t.state&&this.navigate(t.state,"none")});if(mt.isBrowser){t!=null&&t.base?c(this,M,V.normalizeBase(t.base)):c(this,M,"/"),c(this,S,(t==null?void 0:t.waitForHeadToLoad)!==!1),c(this,z,(t==null?void 0:t.cachePages)!==!1),c(this,q,d(this,I,$).call(this,document.body));const i=this.normalizePath(location.pathname);c(this,L,i.pathname),document.documentElement.setAttribute("data-current-pathname",e(this,L)),document.documentElement.setAttribute("data-current-leaf",i.leaf),d(this,F,Z).call(this),addEventListener("popstate",e(this,_))}}get currentPathname(){return e(this,L)}get links(){return e(this,H)}normalizePath(t){return V.splitPath(t,e(this,M))}beforeNavigationEvent(t){return e(this,x).subscribe(t)}afterNavigationEvent(t){return e(this,D).subscribe(t)}prefetch(t){return T(this,null,function*(){const i=this.normalizePath(t);return d(this,R,X).call(this,i.pathname)})}navigate(t,i="push"){return T(this,null,function*(){var g;const a=this.normalizePath(t);let{pathname:s,hash:u,parameters:p,leaf:f}=a;if(e(this,v)===s||e(this,L)===s)return;c(this,v,s);const l=e(this,y).has(s);try{let B=!0;if(e(this,x).notify({pathname:s,isCached:l}),this.preprocessor)try{yield new Promise((o,E)=>{var b;(b=this.preprocessor)==null||b.call(this,{pathname:s,resolve:o,reject:E,isCached:l})})}catch(o){o?console.error(o):console.log("Route change canceled"),B=!1}if(!B||e(this,v)!==s)return;const et=e(this,y).get(s)||(yield d(this,R,X).call(this,s));if(e(this,v)!==s)return;const it=Array.from(document.head.children),st=Array.from(et.head.cloneNode(!0).children),nt=d(this,Y,ct).call(this,it,st),lt=d(this,O,tt).call(this,it,nt),W=d(this,O,tt).call(this,st,nt);W.forEach((o,E)=>{if(o.tagName==="SCRIPT"&&o.getAttribute("src")){const b=document.createElement("script");b.type="module",b.src=o.getAttribute("src"),W[E]=b}}),W.forEach(o=>{document.head.appendChild(o)});const G=W.filter(o=>(o.tagName==="STYLE"||o.tagName==="SCRIPT"||o.tagName==="LINK")&&o.getAttribute("rel")!=="canonical");e(this,S)&&G.length&&(yield new Promise(o=>T(this,null,function*(){let E=0;try{for(var b=ot(G),dt,J,j;dt=!(J=yield b.next()).done;dt=!1){const N=J.value;N.onload=()=>{E++,E===G.length&&o()}}}catch(J){j=[J]}finally{try{dt&&(J=b.return)&&(yield J.call(b))}finally{if(j)throw j[0]}}}))),lt.forEach(o=>{o.hasAttribute("data-permanent")||o.remove()}),c(this,L,s),V.changeHistory(i,s,p,u);const ut=d(this,I,$).call(this,et.body.cloneNode(!0));e(this,q).forEach((o,E)=>{const b=ut[E];let dt=[...o.childNodes],J=[...b.childNodes];dt.forEach(j=>{if(j instanceof HTMLElement){const N=j.getAttribute("data-remain");let rt;J=J.filter(Q=>Q instanceof HTMLElement&&N&&Q.getAttribute("data-remain")===N?(rt=Q,!1):!0),N&&rt||j.remove()}else j.remove()}),o.append(...J)}),d(this,F,Z).call(this),document.documentElement.setAttribute("data-current-pathname",s),document.documentElement.setAttribute("data-current-leaf",f),(g=this.postprocessor)==null||g.call(this,{pathname:s,isCached:l}),e(this,D).notify({pathname:s,isCached:l})}catch(B){console.error(B)}c(this,v,void 0)})}}M=new WeakMap,S=new WeakMap,z=new WeakMap,q=new WeakMap,H=new WeakMap,K=new WeakMap,y=new WeakMap,v=new WeakMap,L=new WeakMap,x=new WeakMap,D=new WeakMap,R=new WeakSet,X=function(t){return T(this,null,function*(){const i=e(this,y).get(t);if(i)return i;const s=yield(yield fetch(t)).text(),u=e(this,K).parseFromString(s,"text/html");return e(this,z)&&e(this,y).set(t,u),u})},F=new WeakSet,Z=function(){const t=[...document.documentElement.querySelectorAll("a")].filter(i=>{var a;return(a=i.getAttribute("href"))==null?void 0:a.startsWith("/")});e(this,H).forEach(i=>i.destroy()),c(this,H,t.map(i=>new ft(i,this)))},I=new WeakSet,$=function(t){return[...t.querySelectorAll("[data-morph]")]},Y=new WeakSet,ct=function(t,i){return t.filter(a=>i.find(s=>s.outerHTML===a.outerHTML))},O=new WeakSet,tt=function(t,i){return t.filter(a=>!i.find(s=>s.outerHTML===a.outerHTML))},_=new WeakMap;exports.Morph=pt;
